<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Путешествие Слипа</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        
        #gameContainer {
            position: relative;
            border: 2px solid #34495e;
            background: #34495e;
        }
        
        canvas {
            display: block;
            background: #87CEEB;
        }
        
        #menuScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
        }
        
        .menuButton {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .menuButton:hover {
            background: #2980b9;
        }
        
        .menuButton:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        
        #gameOverScreen, #winScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
        }
        
        .screenTitle {
            font-size: 36px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .hearts {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            z-index: 5;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .levelIndicator {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 18px;
            z-index: 5;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        #pauseMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
        }
        
        #menuButton {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <button id="menuButton">МЕНЮ</button>
        <div class="hearts" id="heartsDisplay">❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️</div>
        <div class="levelIndicator" id="levelIndicator">Уровень: 1</div>
        
        <div id="menuScreen">
            <h1 style="color: #3498db; margin-bottom: 40px;">Путешествие Слипа</h1>
            <button class="menuButton" id="startButton">Новая игра</button>
            <button class="menuButton" id="savesButton" disabled>Сохранения</button>
            <button class="menuButton" id="settingsButton" disabled>Настройки</button>
        </div>
        
        <div id="pauseMenu">
            <h2 style="color: #3498db; margin-bottom: 30px;">Пауза</h2>
            <button class="menuButton" id="resumeButton">Продолжить</button>
            <button class="menuButton" id="pauseReturnButton">Вернуться в меню</button>
        </div>
        
        <div id="gameOverScreen">
            <h2 class="screenTitle">Game Over</h2>
            <button class="menuButton" id="returnToMenuButton">Вернуться в меню</button>
        </div>
        
        <div id="winScreen">
            <h2 class="screenTitle">Поздравляем!<br>Вы прошли игру!</h2>
            <button class="menuButton" id="winReturnButton">Вернуться в меню</button>
        </div>
    </div>

    <script>
        // Основные переменные игры
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menuScreen');
        const pauseMenu = document.getElementById('pauseMenu');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winScreen = document.getElementById('winScreen');
        const heartsDisplay = document.getElementById('heartsDisplay');
        const levelIndicator = document.getElementById('levelIndicator');
        
        // Кнопки
        const startButton = document.getElementById('startButton');
        const savesButton = document.getElementById('savesButton');
        const settingsButton = document.getElementById('settingsButton');
        const returnToMenuButton = document.getElementById('returnToMenuButton');
        const winReturnButton = document.getElementById('winReturnButton');
        const menuButton = document.getElementById('menuButton');
        const resumeButton = document.getElementById('resumeButton');
        const pauseReturnButton = document.getElementById('pauseReturnButton');
        
        // Игровые переменные
        let gameRunning = false;
        let gamePaused = false;
        let currentLevel = 0;
        let lives = 10;
        let player = {
            x: 50,
            y: 400,
            width: 40,
            height: 40,
            velocityX: 0,
            velocityY: 0,
            speed: 2, // Уменьшена в 2.5 раза
            jumpPower: -13.5, // Уменьшен на 25% (было -18)
            isJumping: false,
            jumpCount: 0, // Счетчик прыжков (для двойного прыжка)
            maxJumps: 2, // Максимум прыжков
            color: '#32CD32',
            facing: 1 // 1 - направо, -1 - налево
        };
        
        let keys = {};
        let bullets = [];
        let lastShotTime = 0; // Время последнего выстрела
        const shotCooldown = 100; // 0.1 секунды = 100мс
        
        // Уровни
        const levels = [
            // Уровень 1: "Стартовая тропа"
            {
                platforms: [
                    { x: 0, y: 500, width: 1000, height: 20 }
                ],
                enemies: [],
                teleport: { x: 950, y: 460, width: 40, height: 40 }
            },
            // Уровень 2: "Первый вызов"
            {
                platforms: [
                    { x: 0, y: 500, width: 350, height: 20 },
                    { x: 470, y: 500, width: 330, height: 20 }
                ],
                enemies: [
                    { x: 600, y: 470, width: 45, height: 45, speed: 0.8, direction: 1, startX: 580, endX: 650, health: 2 }
                ],
                teleport: { x: 760, y: 460, width: 40, height: 40 }
            },
            // Уровень 3: "Лабиринт платформ"
            {
                platforms: [
                    { x: 0, y: 500, width: 200, height: 20 },
                    { x: 250, y: 450, width: 150, height: 20 },
                    { x: 450, y: 400, width: 150, height: 20 },
                    { x: 650, y: 350, width: 150, height: 20 }
                ],
                enemies: [
                    { x: 300, y: 420, width: 45, height: 45, speed: 0.8, direction: 1, startX: 250, endX: 400, health: 2 },
                    { x: 700, y: 320, width: 45, height: 45, speed: 0.8, direction: 1, startX: 650, endX: 800, health: 2 }
                ],
                teleport: { x: 760, y: 310, width: 40, height: 40 }
            },
            // Уровень 4: "Подземелье"
            {
                platforms: [
                    { x: 0, y: 580, width: 150, height: 20 },
                    { x: 200, y: 550, width: 100, height: 20 },
                    { x: 350, y: 520, width: 100, height: 20 },
                    { x: 500, y: 490, width: 100, height: 20 },
                    { x: 650, y: 460, width: 150, height: 20 },
                    { x: 650, y: 360, width: 150, height: 20 },
                    { x: 500, y: 260, width: 100, height: 20 },
                    { x: 350, y: 160, width: 100, height: 20 }
                ],
                enemies: [
                    { x: 220, y: 520, width: 45, height: 45, speed: 0.8, direction: 1, startX: 200, endX: 300, health: 2 },
                    { x: 520, y: 460, width: 45, height: 45, speed: 0.8, direction: 1, startX: 500, endX: 600, health: 2 },
                    { x: 670, y: 330, width: 45, height: 45, speed: 0.8, direction: 1, startX: 650, endX: 800, health: 2 }
                ],
                teleport: { x: 370, y: 120, width: 40, height: 40 }
            },
            // Уровень 5: "Финал"
            {
                platforms: [
                    { x: 0, y: 500, width: 150, height: 20 },
                    { x: 200, y: 450, width: 100, height: 20 },
                    { x: 350, y: 400, width: 100, height: 20 },
                    { x: 500, y: 350, width: 100, height: 20 },
                    { x: 650, y: 300, width: 150, height: 20 },
                    { x: 650, y: 450, width: 150, height: 20 },
                    { x: 500, y: 200, width: 100, height: 20 },
                    { x: 350, y: 150, width: 100, height: 20 },
                    { x: 200, y: 100, width: 100, height: 20 }
                ],
                enemies: [
                    { x: 220, y: 420, width: 45, height: 45, speed: 0.8, direction: 1, startX: 200, endX: 300, health: 2 },
                    { x: 520, y: 320, width: 45, height: 45, speed: 0.8, direction: 1, startX: 500, endX: 600, health: 2 },
                    { x: 670, y: 270, width: 45, height: 45, speed: 0.8, direction: 1, startX: 650, endX: 800, health: 2 },
                    { x: 370, y: 120, width: 45, height: 45, speed: 0.8, direction: 1, startX: 350, endX: 450, health: 2 }
                ],
                teleport: { x: 220, y: 60, width: 40, height: 40 }
            }
        ];
        
        let currentLevelData = null;
        
        // Инициализация игры
        function initGame() {
            currentLevel = 0;
            lives = 10;
            bullets = [];
            lastShotTime = 0;
            updateHeartsDisplay();
            loadLevel(currentLevel);
            gameRunning = true;
            gamePaused = false;
            menuScreen.style.display = 'none';
            pauseMenu.style.display = 'none';
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            animate();
        }
        
        // Загрузка уровня
        function loadLevel(levelIndex) {
            if (levelIndex >= levels.length) {
                showWinScreen();
                return;
            }
            
            currentLevelData = JSON.parse(JSON.stringify(levels[levelIndex])); // Копируем уровень
            player.x = 50;
            player.y = 400;
            player.velocityX = 0;
            player.velocityY = 0;
            player.jumpCount = 0;
            player.facing = 1; // Сначала смотрит направо
            bullets = [];
            lastShotTime = 0;
            
            levelIndicator.textContent = `Уровень: ${levelIndex + 1}`;
        }
        
        // Обновление отображения жизней
        function updateHeartsDisplay() {
            heartsDisplay.textContent = '❤️'.repeat(lives);
        }
        
        // Проверка столкновений AABB
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }
        
        // Проверка столкновения пули (круга) с врагом (прямоугольника)
        function checkBulletEnemyCollision(bullet, enemy) {
            // Находим ближайшую точку на прямоугольнике к центру пули
            let closestX = Math.max(enemy.x, Math.min(bullet.x, enemy.x + enemy.width));
            let closestY = Math.max(enemy.y, Math.min(bullet.y, enemy.y + enemy.height));
            
            // Вычисляем расстояние между центром пули и ближайшей точкой
            const distanceX = bullet.x - closestX;
            const distanceY = bullet.y - closestY;
            const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
            
            // Если расстояние меньше радиуса пули, произошло столкновение
            return distance < bullet.radius;
        }
        
        // Обновление состояния игрока
        function updatePlayer() {
            // Управление
            player.velocityX = 0;
            if (keys['a'] || keys['ф'] || keys['ArrowLeft']) {
                player.velocityX = -player.speed;
                player.facing = -1; // Смотрит влево
            }
            if (keys['d'] || keys['в'] || keys['ArrowRight']) {
                player.velocityX = player.speed;
                player.facing = 1; // Смотрит вправо
            }
            
            // Прыжок
            if ((keys[' '] || keys['Spacebar']) && player.jumpCount < player.maxJumps) {
                if (player.jumpCount === 0 || (player.jumpCount === 1 && !player.isJumping)) {
                    player.velocityY = player.jumpPower;
                    player.isJumping = true;
                    player.jumpCount++;
                }
            }
            
            // Выстрел
            if ((keys['j'] || keys['д']) && Date.now() - lastShotTime > shotCooldown) {
                shootBullet();
                lastShotTime = Date.now(); // Обновляем время последнего выстрела
            }
            
            // Применение гравитации
            player.velocityY += 0.6;
            
            // Обновление позиции
            player.x += player.velocityX;
            player.y += player.velocityY;
            
            // Проверка столкновений с платформами
            let onGround = false;
            for (let platform of currentLevelData.platforms) {
                if (checkCollision(player, platform)) {
                    // Сверху платформы
                    if (player.velocityY > 0 && player.y < platform.y) {
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.isJumping = false;
                        player.jumpCount = 0; // Сбрасываем счетчик прыжков при приземлении
                        onGround = true;
                    }
                    // Снизу платформы
                    else if (player.velocityY < 0 && player.y > platform.y) {
                        player.y = platform.y + platform.height;
                        player.velocityY = 0;
                    }
                    // Справа платформы
                    else if (player.velocityX > 0 && player.x < platform.x) {
                        player.x = platform.x - player.width;
                    }
                    // Слева платформы
                    else if (player.velocityX < 0 && player.x > platform.x) {
                        player.x = platform.x + platform.width;
                    }
                }
            }
            
            // Если не на земле и не прыгаем, сбрасываем счетчик прыжков
            if (!onGround && player.velocityY >= 0) {
                player.isJumping = true;
            }
            
            // Проверка выхода за границы
            if (player.y > canvas.height) {
                loseLife();
            }
        }
        
        // Создание пули
        function shootBullet() {
            // Направление стрельбы зависит от направления взгляда
            const direction = player.facing;
            const startX = player.x + player.width/2;
            const startY = player.y + player.height/2;
            
            bullets.push({
                x: startX,
                y: startY,
                radius: 5,
                speed: 8,
                direction: direction,
                startTime: Date.now(),
                lifetime: 1000 // 1 секунда
            });
        }
        
        // Обновление пуль
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                
                // Обновляем позицию пули
                bullet.x += bullet.speed * bullet.direction;
                
                // Проверяем время жизни пули
                if (Date.now() - bullet.startTime > bullet.lifetime) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // Проверяем столкновение с врагами
                for (let j = currentLevelData.enemies.length - 1; j >= 0; j--) {
                    const enemy = currentLevelData.enemies[j];
                    
                    if (checkBulletEnemyCollision(bullet, enemy)) {
                        enemy.health -= 1;
                        bullets.splice(i, 1); // Удаляем пулю при попадании
                        
                        if (enemy.health <= 0) {
                            currentLevelData.enemies.splice(j, 1); // Удаляем врага при смерти
                        }
                        break;
                    }
                }
                
                // Проверяем выход за границы экрана
                if (bullet.x < 0 || bullet.x > canvas.width) {
                    bullets.splice(i, 1);
                }
            }
        }
        
        // Обновление врагов
        function updateEnemies() {
            for (let i = currentLevelData.enemies.length - 1; i >= 0; i--) {
                const enemy = currentLevelData.enemies[i];
                
                // Движение врага
                enemy.x += enemy.speed * enemy.direction;
                
                // Изменение направления при достижении границ
                if (enemy.x <= enemy.startX || enemy.x + enemy.width >= enemy.endX) {
                    enemy.direction *= -1;
                }
                
                // Проверка столкновения с игроком
                if (checkCollision(player, enemy)) {
                    loseLife();
                }
            }
        }
        
        // Проверка телепорта
        function checkTeleport() {
            if (checkCollision(player, currentLevelData.teleport)) {
                if (currentLevel < levels.length - 1) {
                    currentLevel++;
                    loadLevel(currentLevel);
                } else {
                    showWinScreen();
                }
            }
        }
        
        // Потеря жизни
        function loseLife() {
            lives--;
            updateHeartsDisplay();
            
            if (lives <= 0) {
                showGameOverScreen();
            } else {
                // Респаун игрока
                player.x = 50;
                player.y = 400;
                player.velocityX = 0;
                player.velocityY = 0;
                player.jumpCount = 0;
                player.facing = 1; // Сначала смотрит направо
            }
        }
        
        // Отображение экрана Game Over
        function showGameOverScreen() {
            gameRunning = false;
            gameOverScreen.style.display = 'flex';
        }
        
        // Отображение экрана победы
        function showWinScreen() {
            gameRunning = false;
            winScreen.style.display = 'flex';
        }
        
        // Пауза игры
        function togglePause() {
            if (gameRunning && !gamePaused) {
                gamePaused = true;
                pauseMenu.style.display = 'flex';
            }
        }
        
        // Продолжение игры
        function resumeGame() {
            if (gameRunning && gamePaused) {
                gamePaused = false;
                pauseMenu.style.display = 'none';
                animate();
            }
        }
        
        // Отрисовка игры
        function draw() {
            // Очистка холста
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем платформы
            ctx.fillStyle = '#8B4513';
            for (let platform of currentLevelData.platforms) {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            }
            
            // Рисуем игрока (Слип)
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.ellipse(player.x + player.width/2, player.y + player.height/2, player.width/2, player.height/2, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Рисуем глаза персонажа
            ctx.fillStyle = '#000';
            const eyeOffsetX = player.facing > 0 ? 8 : -8; // Смещение в зависимости от направления взгляда
            const eyeOffsetY = -5; // Смещение вверх
            
            // Левый глаз
            ctx.beginPath();
            ctx.arc(
                player.x + player.width/2 - eyeOffsetX,
                player.y + player.height/2 + eyeOffsetY,
                4, 0, Math.PI * 2
            );
            ctx.fill();
            
            // Правый глаз
            ctx.beginPath();
            ctx.arc(
                player.x + player.width/2 + eyeOffsetX,
                player.y + player.height/2 + eyeOffsetY,
                4, 0, Math.PI * 2
            );
            ctx.fill();
            
            // Рисуем врагов
            for (let enemy of currentLevelData.enemies) {
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                
                // Показываем здоровье врага
                ctx.fillStyle = '#FFF';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(enemy.health.toString(), enemy.x + enemy.width/2, enemy.y + enemy.height/2 + 4);
                
                // Глаза врага
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(enemy.x + 12, enemy.y + 12, 4, 0, Math.PI * 2);
                ctx.arc(enemy.x + 33, enemy.y + 12, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Рисуем пули
            ctx.fillStyle = '#FFD700'; // Желтый цвет
            for (let bullet of bullets) {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Рисуем телепорт (с анимацией мигания)
            const alpha = 0.5 + 0.5 * Math.sin(Date.now() / 200);
            ctx.globalAlpha = alpha;
            ctx.fillStyle = '#8A2BE2';
            ctx.fillRect(currentLevelData.teleport.x, currentLevelData.teleport.y, currentLevelData.teleport.width, currentLevelData.teleport.height);
            ctx.globalAlpha = 1.0;
        }
        
        // Основной игровой цикл
        function animate() {
            if (!gameRunning || gamePaused) return;
            
            updatePlayer();
            updateBullets();
            updateEnemies();
            checkTeleport();
            draw();
            
            requestAnimationFrame(animate);
        }
        
        // Обработчики событий
        window.addEventListener('keydown', function(e) {
            keys[e.key.toLowerCase()] = true;
        });
        
        window.addEventListener('keyup', function(e) {
            keys[e.key.toLowerCase()] = false;
        });
        
        // Обработчики кнопок
        startButton.addEventListener('click', initGame);
        returnToMenuButton.addEventListener('click', function() {
            menuScreen.style.display = 'flex';
            gameOverScreen.style.display = 'none';
            gameRunning = false;
        });
        
        winReturnButton.addEventListener('click', function() {
            menuScreen.style.display = 'flex';
            winScreen.style.display = 'none';
            gameRunning = false;
        });
        
        menuButton.addEventListener('click', togglePause);
        resumeButton.addEventListener('click', resumeGame);
        pauseReturnButton.addEventListener('click', function() {
            menuScreen.style.display = 'flex';
            pauseMenu.style.display = 'none';
            gameRunning = false;
        });
        
        // Инициализация начального состояния
        updateHeartsDisplay();
    </script>
</body>
</html>
